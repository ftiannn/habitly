name: Deploy

on:
  workflow_dispatch:
    inputs:
      what:
        description: "What to deploy"
        required: true
        type: choice
        options:
          - infrastructure-prod
          - backend-prod
          - everything-prod
      confirm:
        description: 'Type "GO" to confirm'
        required: true
        type: string

jobs:
  deploy:
    name: Deploy ${{ inputs.what }}
    runs-on: ubuntu-latest
    environment: production  # ADD THIS - to access environment secrets
    if: inputs.confirm == 'GO'

    env:
      API_URL_PROD: ${{ vars.API_URL_PROD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: Deploy Infrastructure
        if: contains(inputs.what, 'infrastructure') || contains(inputs.what, 'everything')
        run: |
          echo "Starting production infrastructure deployment..."
          cd infrastructure/environments/prod

          echo "Setting up environment variables..."
          export TF_VAR_database_url="${{ secrets.PROD_DATABASE_URL }}"
          export TF_VAR_jwt_secret="${{ secrets.PROD_JWT_SECRET }}"
          export TF_VAR_google_client_id="${{ secrets.PROD_GOOGLE_CLIENT_ID }}"
          export TF_VAR_google_client_secret="${{ secrets.PROD_GOOGLE_CLIENT_SECRET }}"

          echo "Initializing Terraform..."
          terraform init

          echo "Applying infrastructure changes..."
          terraform apply -auto-approve

          echo "Infrastructure deployed to production"

      - name: Deploy Backend
        if: contains(inputs.what, 'backend') || contains(inputs.what, 'everything')
        run: |
          echo "Starting production backend deployment..."
          cd apps/backend

          echo "Installing dependencies..."
          npm ci

          echo "Generating Prisma client..."
          npm run prisma:generate

          echo "Configuring production environment..."
          cat > .env << EOF
          DATABASE_URL="${{ secrets.PROD_DATABASE_URL }}"
          JWT_SECRET="${{ secrets.PROD_JWT_SECRET }}"
          GOOGLE_CLIENT_ID="${{ secrets.PROD_GOOGLE_CLIENT_ID }}"
          GOOGLE_CLIENT_SECRET="${{ secrets.PROD_GOOGLE_CLIENT_SECRET }}"
          STAGE="prod"
          NODE_ENV="production"
          AWS_REGION="ap-southeast-1"
          EOF

          echo "Running database migrations..."
          npm run prisma:deploy

          echo "Installing serverless framework..."
          npm install -g serverless@3

          echo "Deploying serverless functions..."
          npm run deploy:prod

          echo "Backend deployed to production"

      - name: Test Deployment
        if: contains(inputs.what, 'backend') || contains(inputs.what, 'everything')
        run: |
          echo "Running post-deployment tests..."
          URL="${{ vars.API_URL_PROD }}"
          echo "Testing production API at $URL"

          echo "Running API health checks..."
          echo "  Testing categories endpoint..."
          if curl -f "$URL/categories" --connect-timeout 10 --max-time 30; then
            echo "  Categories endpoint: OK"
          else
            echo "  Warning: Categories test failed"
          fi

          echo "  Testing docs endpoint..."
          if curl -f "$URL/docs" --connect-timeout 10 --max-time 30; then
            echo "  Docs endpoint: OK"
          else
            echo "  Warning: Docs test failed"
          fi

          echo "API testing completed for $URL"

      - name: Deployment Complete
        run: |
          echo "=============================="
          echo "PRODUCTION DEPLOYMENT SUMMARY"
          echo "=============================="
          echo ""
          echo "Component: ${{ inputs.what }}"
          echo "Status: Completed Successfully"
          echo "Time: $(date)"
          echo ""
          echo "Production Environment:"
          echo "  API: ${{ vars.API_URL_PROD }}"
          echo "  Documentation: ${{ vars.API_URL_PROD }}/docs"
          echo ""
          echo "Production deployment completed successfully!"